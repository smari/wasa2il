{% extends "base.html" %}
{% load i18n %}
{% block content %}

<div style="float:right;" class="btn-group">
{% if user_is_member %}
  <a class="btn" href="/polity/{{polity.id}}/topic/new/">{% trans "New topic" %}</a>
  <a class="btn" href="/polity/{{polity.id}}/document/new/">{% trans "New document" %}</a>
  <a class="btn" href="/polity/{{polity.id}}/meeting/new/">{% trans "New meeting" %}</a>
  <a class="btn" href="/polity/{{polity.id}}/leave/">{% trans "Leave polity" %}</a>
{% endif %}
{% if not user_is_member and not user_requested_membership %}
<a class="btn" href="/polity/{{polity.id}}/join/">{% trans "Join polity" %}</a>
	{% if polity.invite_threshold == 0 %}
	<a class="btn" href="/polity/{{polity.id}}/join/">{% trans "Request to join polity" %}</a>
	{% endif %}
{% endif %}
</div>
<h1>{{polity.name}}</h1>

{% if user_requested_membership %}
	{% if user_requested_membership_now %}
		<div class="alert alert-success">{% trans "Your request to join has been sent." %}</div>
	{% else %}
		<div class="alert alert-success">{% trans "Your request to join this polity is still pending." %}</div>
	{% endif %}
{% endif %}

<div id="polity_stats" class="subnav">
	<ul class="nav nav-pills">
		<li><a href="#" onclick="$('#modal_members').modal('show');">{{polity.members.count}} {% trans "members" %}</a></li>
		<li><a href="#topics">{{polity.topic_set.count}} {% trans "topics" %}</a></li>
		<li><a href="#documents">{{polity.document_set.count}} {% trans "documents" %}</a></li>
		<li><a href="#subpolities">{{polity.polity_set.count}} {% trans "subpolities" %}</a></li>
	
	{% if user_is_member %}
		{% if polity.invite_threshold > 0 %}
			{% if membership_requests.count == 0 %}
			<li class="disabled"><a href="#">{{membership_requests.count}} {% trans "membership requests" %}</a></li>
			{% else %}
			<li><a href="#" onclick="$('#modal_requests').modal('show');">{{membership_requests.count}} {% trans "membership requests" %}</a></li>
			{% endif %}
		{% endif %}
	{% endif %}	
	</ul>
</div>

<div><a name="topics"></a>
	<h2>{% trans "Topics" %} <small>{% trans "of discussion"%}</small></h2>
	<table class="table table-striped table-bordered">
	<tr>
		<th>{% trans "Topics" %}</th>
		<th>{% trans "Issues" %}</th>
		<th>{% trans "Open Issues" %}</th>
		<th>{% trans "Voting Issues" %}</th>
	</tr>
	{% for topic in polity.topic_set.all %}
	<tr>
		<td><a href="/polity/{{polity.id}}/topic/{{topic.id}}/">{{topic.name}}</a></td>
		<td>{{topic.issue_set.count}}</td>
		<td>{{topic.issue_set.count}}</td>
		<td>{{topic.issue_set.count}}</td>
	</tr>
	{% empty %}
	<tr>
		<td colspan="4" style="text-align: center; font-size: 110%;">
			{% trans "There are no topics in this polity!" %}
			{% if user_is_member %}<a href="/polity/{{polity.id}}/topic/new/">Start a new topic</a>{% endif %}
		</td>
	</tr>
	{% endfor %}
	</table>
</div>


<div><a name="documents"></a>
	<h2>{% trans "Documents" %} <small>{% trans "proposed or in progress" %}</small></h2>

	{% with polity.document_set.all as documents %}
	{% include "core/_document_list_table.html" %}
	{% endwith %}
</div>


{% if polity.polity_set.all %}
<div><a name="subpolities"></a>
	<h2>{% trans "Subpolities" %}</h2>
	<ul>
	{% for subpolity in polity.polity_set.all %}
		<li><a href="/polity/{{subpolity.id}}/">{{subpolity.name}}</a></li>
	{% endfor %}
	</ul>
</div>
{% endif %}



<div class="modal hide fade" id="modal_members">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h3>{% trans "Members of this polity" %}</h3>
  </div>
  <div class="modal-body" id="modal_members_list">

	{% for m in polity.members.all %}
		<a href="/accounts/profile/{{m.username}}/" class="thumbnail" style="background: url('/static/img/blank-user-icon.jpg') no-repeat">
			{{m.username}}
		</a>
	{% endfor %}

  </div>
  <div class="modal-footer">
    <a onclick="$('#modal_members').modal('hide');" class="btn btn-primary">{% trans "Close" %}</a>
  </div>
</div>


<div class="modal hide fade" id="modal_requests">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h3>{% trans "Users requesting membership" %}</h3>
  </div>
  <div class="modal-body">

  	<ul class="nobullets">
	{% for m in membership_requests %}
		<li>
			<a
				id="membershiprequest_{{m.requestor.id}}"
				class="thumbnail member membership_request"
				href="#"
				data-id="{{m.id}}"
				data-csrftoken="{{csrf_token}}"
				onclick="polity_membership_vote({{polity.id}}, {{m.requestor.id}});">
	            <img src="/static/img/blank-user-icon.jpg" />
	            <div class="title">
	                <div class="title">{{m.requestor.username}}</div>
	                <div class="progress">
						<div id="membershiprequest_percent_{{m.requestor.id}}" class="bar bar-success" style="width: {{m.votespercent}}%;">
							{{m.votes}}/{{m.votesneeded}}
						</div>
					</div>
	            </div>
	        </a>
    	</li>
	{% endfor %}
	</ul>

  </div>
  <div class="modal-footer">
    <a onclick="$('#modal_requests').modal('hide');" class="btn btn-primary">{% trans "Close" %}</a>
  </div>
</div>


{% endblock %}
